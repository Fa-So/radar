'use strict';

angular.module('radarApp')
    .directive('connectionSetup', ['$window',
    function ($window) {
      return {
        restrict: 'A',
        templateUrl: 'partials/state.html',
        replace: true,
        scope: {
            connect: '&',
	    status: '=',
	    disconnect: '&'
        },
          controller: function ($scope) {
	      $scope.expanded = false;
	          var storage = $window.localStorage;
    storage['radar.connections'] = storage['radar.connections'] || '[]';
    var storedConnections;
    try {
      storedConnections = JSON.parse(storage['radar.connections']);
    } catch(e) {
      storedConnections = [];
    }
    $scope.storedConnections = storedConnections;
    var validateWsUrl = function(url) {
      var regexp = /(ws|wss):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;
      return regexp.test(url);
    };
    $scope.isValidWsUrl = false;
    $scope.removeStoredConnection = function(con) {
      storedConnections.splice(storedConnections.indexOf(con),1);
    };
    $scope.$watch('newUrl', function(url) {
      $scope.isValidWsUrl = validateWsUrl(url);
      //$scope.$apply();
    });
    $scope.storedConnections = storedConnections;
    $scope.$watch('storedConnections', function(connections) {
      console.log(connections);
      storage['radar.connections'] = JSON.stringify(connections);
    }, true);
    $scope.newUrl = '';

        }
      };
    }
  ]);
